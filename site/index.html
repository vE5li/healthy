<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg"/>
    <title>Device Status</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #222;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            padding: 0.4rem 0.6472rem;
            text-align: left;
            overflow: hidden;
        }
        table.domains-table th:nth-child(1),
        table.domains-table td:nth-child(1) {
            width: 85%;
        }
        table.domains-table th:nth-child(2),
        table.domains-table td:nth-child(2) {
            width: 15%;
        }
        table.devices-table th:nth-child(1),
        table.devices-table td:nth-child(1) {
            width: 30%;
        }
        table.devices-table th:nth-child(2),
        table.devices-table td:nth-child(2) {
            width: 55%;
        }
        table.devices-table th:nth-child(3),
        table.devices-table td:nth-child(3) {
            width: 15%;
        }
        th {
            background-color: #292929;
            color: #999;
            font-weight: bold;
        }
        tbody tr:nth-child(odd) {
            background-color: #353535;
            color: #bbb;
        }
        tbody tr:nth-child(even) {
            background-color: #303030;
            color: #bbb;
        }
        .connected {
            color: #42ff9b;
        }
        .disconnected {
            color: #ff6142;
        }
        .latency-connected {
            color: #7a7a7a;
        }
        .latency-disconnected {
            color: #555;
        }
        :link { color: white; }
        :visited { color: white; }
        :link:active, :visited:active { color: #bbffbb; }
    </style>
</head>
<body>
    <div id="status">Loading...</div>

    <script>
        let initialized = false;

        function sanitizeId(str) {
            return str.replace(/[^a-zA-Z0-9]/g, '-');
        }

        function initializeTables(domains, devices) {
            const domainRows = domains.map(domain => {
                const domainId = sanitizeId(domain.domain);
                return `<tr>
                      <td><a href="${domain.domain}">${domain.domain}</a></td>
                      <td id="domain-status-${domainId}"></td>
                    </tr>`;
            }).join('');

            const domainsHtml = `<table class="domains-table">
              <thead>
                <tr>
                  <th scope="col">Domain</th>
                  <th scope="col">Status</th>
                </tr>
              </thead>
              <tbody>
                ${domainRows}
              </tbody>
            </table>`;

            const deviceRows = devices.map(device => {
                const deviceId = sanitizeId(device.name);
                return `<tr>
                      <td>${device.name}</td>
                      <td id="device-ip-${deviceId}"></td>
                      <td id="device-latency-${deviceId}"></td>
                    </tr>`;
            }).join('');

            const devicesHtml = `<table class="devices-table">
              <thead>
                <tr>
                  <th scope="col">Name</th>
                  <th scope="col">Ip</th>
                  <th scope="col">Latency</th>
                </tr>
              </thead>
              <tbody>
                ${deviceRows}
              </tbody>
            </table>`;

            document.getElementById('status').innerHTML = domainsHtml + "<br/>" + devicesHtml;
        }

        function updateStatus(domains, devices) {
            domains.forEach(domain => {
                const className = (domain.status >= 200 && domain.status < 300) ? 'connected' : 'disconnected';
                const domainId = sanitizeId(domain.domain);
                const cell = document.getElementById(`domain-status-${domainId}`);
                if (cell && (cell.textContent != domain.status)) {
                    cell.textContent = domain.status;
                    cell.className = className;
                }
            });

            devices.forEach(device => {
                const className = device.latency_milliseconds ? 'connected' : 'disconnected';
                const latencyClassName = device.latency_milliseconds ? 'latency-connected' : 'latency-disconnected';
                const latency = device.latency_milliseconds ? `${device.latency_milliseconds} ms` : '-';
                const deviceId = sanitizeId(device.name);

                const ipCell = document.getElementById(`device-ip-${deviceId}`);
                if (ipCell && (ipCell.textContent != device.ip || ipCell.className != className)) {
                    ipCell.textContent = device.ip;
                    ipCell.className = className;
                }

                const latencyCell = document.getElementById(`device-latency-${deviceId}`);
                if (latencyCell && (latencyCell.textContent != latency)) {
                    latencyCell.textContent = latency;
                    latencyCell.className = latencyClassName;
                }
            });
        }

        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const json = await response.json();
                const domains = json.domains;
                const devices = json.devices;

                if (!initialized) {
                    initializeTables(domains, devices);
                    initialized = true;
                }

                updateStatus(domains, devices);
            } catch (err) {
                document.getElementById('status').innerHTML = '<p>Error loading status</p>';
            }
        }

        checkStatus();
        setInterval(checkStatus, 500);
    </script>
</body>
</html>
